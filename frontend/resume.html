<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Resume Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 p-6">

    <h1 class="text-3xl font-bold mb-6 text-center text-blue-700">Submitted Resumes</h1>

    <div class="flex justify-center mb-4">
        <input id="searchInput" type="text" placeholder="Search by name or skill..."
            class="w-full max-w-md p-2 border border-gray-300 rounded shadow-sm" />
    </div>

    <div class="text-center text-gray-600 mb-4" id="total-count"></div>

    <div id="resume-list" class="grid grid-cols-1 sm:grid-cols-2 gap-6 h-[70vh] overflow-y-auto p-2"></div>

    <div class="flex justify-center gap-4 mt-6">
        <button id="refreshBtn" class="bg-gray-700 hover:bg-gray-900 text-white font-bold px-4 py-2 rounded">
            ðŸ”„ Refresh
        </button>
    
        <button onclick="downloadCSV()" class="bg-green-600 hover:bg-green-700 text-white font-bold px-4 py-2 rounded">
            ðŸ“¥ Export CSV
        </button>
    </div>
    

    <script>
        let allResumes = [];

        function highlightMatch(text, query) {
            if (!query) return text;
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span class="bg-yellow-200 font-bold">$1</span>');
        }

        async function loadResumes() {
            try {
                const res = await fetch("http://127.0.0.1:5000/resume");
                const data = await res.json();

                data.sort((a, b) => b.score - a.score);

                allResumes = data;
                renderResumes(data);

                document.getElementById("total-count").innerText =
                    `Total Resumes Submitted: ${data.length}`;


            } catch (error) {
                console.error("Error fetching resumes:", error);
            }
        }

        function renderResumes(resumes) {
            const query = document.getElementById("searchInput").value.toLowerCase();
            const container = document.getElementById("resume-list");
            container.innerHTML = "";

            document.getElementById("total-count").innerText = 
             `showing ${resumes.length} of ${allResumes.length} resumes`;

            if (resumes.length === 0) {
                container.innerHTML = `<p class="text-gray-500">No resumes found.</p>`;
                return;
            }

            resumes.forEach((resume, index) => {
                const card = document.createElement("div");

                let borderColor = "border-gray-300";
                if (resume.score >= 85) borderColor = "border-green-500";
                else if (resume.score >= 60) borderColor = "border-blue-400";
                else if (resume.score >= 30) borderColor = "border-yellow-400";
                else borderColor = "border-red-500";

                card.className = `bg-white p-5 rounded-lg shadow-md border ${borderColor} hover:shadow-lg transition`;

                const highlightedName = highlightMatch(resume.name, query);
                const highlightedSkills = highlightMatch(resume.skills.join(', '), query);

                card.innerHTML = `
          <h3 class="text-xl font-semibold mb-2">#${index + 1}: ${highlightedName}</h3>
          <p><strong>Email:</strong> ${resume.email}</p>
          <p><strong>Skills:</strong> ${highlightedSkills}</p>
          <p><strong>Education:</strong> ${resume.education}</p>
          <p><strong>Experience:</strong> ${resume.experience}</p>
          <p><strong>Projects:</strong> ${resume.projects}</p>
          <p><strong>Certifications:</strong> ${resume.certifications}</p>
          <p><strong>score:</strong> ${resume.score}%</p>
          <p><strong>Recommendation:</strong> ${resume.recommendation}</p>
          <p><strong>Feedback:</strong><br>
            ${resume.feedback ? resume.feedback.join('<br>') : "No feedback available"}
          </p>
        `;
                container.appendChild(card);
            });
        }

        //Live filtering on input
        document.getElementById("searchInput").addEventListener("input", () => {
            const query = document.getElementById("searchInput").value.toLowerCase();
            const filtered = allResumes.filter(resume =>
                resume.name.toLowerCase().includes(query) ||
                resume.skills.join(',').toLowerCase().includes(query)
            );
            renderResumes(filtered);
        });


        //refresh search manually
        document.getElementById("refreshBtn").addEventListener("click", loadResumes);

        //Initial load on page open
        window.addEventListener("load", () => {
            loadResumes();
        });

        function downloadCSV() {
            window.open("http://127.0.0.1:5000/export", "_blank");
        }

    </script>

</body>

</html>